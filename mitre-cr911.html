<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MiTRE-CR911 — ATT&CK-style Matrix</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  :root{ --bg:#061226; --panel:#0b1624; --muted:#9fb0c9; --accent:#00d9a3; --card:#0f2230; --cell-border: rgba(255,255,255,0.06); }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#031028 0%,#061428 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#e6eef8}
  header{padding:28px 32px;display:flex;align-items:center;gap:16px}
  header h1{margin:0;color:var(--accent);font-size:20px}
  .wrap{padding:10px 20px 40px;max-width:1400px;margin:0 auto}
  .controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .search{padding:10px 12px;border-radius:10px;border:0;background:#042034;color:#cfe8ff;min-width:260px}
  .matrix-table{display:flex;gap:12px;align-items:flex-start;overflow:auto;padding-bottom:8px}
  .column{min-width:260px;background:transparent;border-radius:8px;padding:6px;flex:0 0 260px}
  .col-head{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));padding:10px;border-radius:8px;border:1px solid var(--cell-border);font-weight:700;color:var(--accent);font-size:14px;text-align:center}
  .cell-grid{margin-top:8px;display:flex;flex-direction:column;gap:8px}
  .cell{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);cursor:pointer;transition:transform .12s,box-shadow .12s}
  .cell:hover{transform:translateY(-4px);box-shadow:0 12px 36px rgba(0,0,0,0.6)}
  .cell .title{font-weight:600;font-size:13px}
  .cell .meta{font-size:12px;color:#9fb0c9;margin-top:6px}

  .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(1,8,14,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:40}
  .modal{background:#041825;border-radius:14px;padding:0;max-width:1000px;width:100%;max-height:90vh;overflow:hidden;border:1px solid rgba(255,255,255,0.08);box-shadow:0 20px 60px rgba(0,0,0,0.7)}
  .modal header{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,0.06);align-items:center;gap:10px}
  .modal h2{margin:0;color:#e9f7ff;font-size:18px}
  .modal .subtitle{color:#9fb0c9;font-size:12px}
  .modal .toolbar{margin-left:auto;display:flex;gap:8px}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;background:#072432;border:1px solid rgba(255,255,255,0.08);color:#bfefff;text-decoration:none;font-size:12px;cursor:pointer}
  .btn:hover{filter:brightness(1.08)}
  .close-btn{background:transparent;border:1px solid rgba(255,255,255,0.12);color:#bfefff}
  .content{display:grid;grid-template-columns:1fr 260px;gap:0;min-height:0}
  .playbook-pane{padding:18px 20px;overflow:auto}
  .meta-pane{border-left:1px solid rgba(255,255,255,0.06);padding:18px 16px;overflow:auto;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.015))}
  .tag{display:inline-block;background:rgba(255,255,255,0.05);padding:6px 8px;border-radius:8px;color:#cfe8ff;font-size:12px;margin-right:6px;margin-top:6px}
  .section-title{font-weight:700;margin:10px 0 6px;color:#cfe8ff;font-size:13px}
  .prose{line-height:1.6;font-size:15px;color:#e9f4ff}
  .prose h1,.prose h2,.prose h3{color:#e9f7ff;margin:14px 0 6px}
  .prose h1{font-size:22px} .prose h2{font-size:18px} .prose h3{font-size:16px}
  .prose p{margin:8px 0}
  .prose ul, .prose ol{padding-left:20px;margin:8px 0}
  .prose code{background:#0a1f33;padding:2px 6px;border-radius:6px}
  .prose pre{background:#0a1f33;border:1px solid rgba(255,255,255,0.06);padding:12px;border-radius:10px;overflow:auto}
  .prose table{border-collapse:collapse;width:100%;margin:10px 0}
  .prose th,.prose td{border:1px solid rgba(255,255,255,0.1);padding:8px 10px}
  .prose a{color:#83d9ff;text-decoration:none;border-bottom:1px dotted rgba(131,217,255,.4)}
  .prose a:hover{border-bottom-color:#83d9ff}
  footer{max-width:1200px;margin:20px auto 60px;padding:0 20px;color:#9fb0c9;font-size:13px}
  @media(max-width:980px){ .content{grid-template-columns:1fr} .meta-pane{border-left:0;border-top:1px solid rgba(255,255,255,0.06)} }
</style>
</head>
<body>
<header>
  <svg width="44" height="44" viewBox="0 0 24 24" fill="none" aria-hidden>
    <rect width="24" height="24" rx="6" fill="#001827"></rect>
    <path d="M6 12h12M12 6v12" stroke="#00d9a3" stroke-width="1.6" stroke-linecap="round"/>
  </svg>
  <div>
    <h1>MiTRE-CR911 — ATT&CK-style Matrix</h1>
    <div style="color:#9fb0c9;font-size:13px">Columns = tactics. Click a technique to open a presentable playbook (Markdown rendered → HTML).</div>
  </div>
</header>

<div class="wrap">
  <div class="controls">
    <input id="q" class="search" placeholder="Filter tactics or techniques..." />
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="playbooks/index.html">Playbooks</a>
  </div>
  <div class="matrix-table" id="matrix"></div>
</div>

<div id="backdrop" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal" role="document" aria-modal="true">
    <header>
      <div>
        <h2 id="modal-title">Technique Playbook</h2>
        <div class="subtitle" id="modal-sub"></div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btn-print">Print</button>
        <a class="btn" id="btn-open-raw" target="_blank" rel="noopener">Open raw</a>
        <a class="btn" id="btn-download">Download .md</a>
        <button class="btn close-btn" id="closeBtn" aria-label="Close">Close</button>
      </div>
    </header>
    <div class="content">
      <div class="playbook-pane">
        <div id="modal-content" class="prose"></div>
      </div>
      <aside class="meta-pane">
        <div class="section-title">Mitigations</div>
        <div id="mitigations"></div>
        <div class="section-title">Affected Elements</div>
        <div id="affected"></div>
        <div class="section-title">Evidence</div>
        <div id="evidence" style="color:#9fb0c9;font-size:13px"></div>
      </aside>
    </div>
  </div>
</div>

<footer>MiTRE-CR911 — <code>mapping.json</code> is the single source of truth. Keep evidence private if needed.</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.7/purify.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
  const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  function renderMarkdown(md){
    marked.setOptions({ mangle:false, headerIds:true, breaks:false });
    const html = marked.parse(md);
    return DOMPurify.sanitize(html);
  }
  function highlightCode(){ try{ hljs.highlightAll(); }catch(e){} }

  function buildPlaybookFromTech(tactic, tech){
    const lines = [];
    lines.push('# ' + esc(tech.name));
    if(tech.description) lines.push('\\n' + esc(tech.description));
    lines.push('\\n## Detection & Telemetry');
    const id=tech.id||''; let sig=[];
    if(['lis_impersonation','lis_data_tamper','data_exfil_lis'].includes(id))
      sig=['Certificate or signer mismatch for PIDF-LO/location tokens','Unusual LVF revalidations','Location-by-value vs by-reference mismatch','Spikes in LIS queries from atypical clients'];
    else if(['tdos_sip_flood','caller_id_spoof','lis_query_flood'].includes(id))
      sig=['SIP INVITE surges from few IPs','ESRP 4xx/5xx & PSAP queue spikes','BCF rate-limit counters firing','Invalid STIR/SHAKEN attestations'];
    else if(['lvf_gis_poison'].includes(id))
      sig=['LVF validation failures after data updates','GIS hash/version drift','Unauthorized LVF/GIS writes'];
    else if(['legacy_protocol_injection','rtp_injection'].includes(id))
      sig=['LNG/LPG protocol conformance violations','RTP/SRTP negotiation anomalies','Unexpected SDP/codec attributes'];
    else if(['sw_bugs_esrp','protocol_downgrade'].includes(id))
      sig=['ESRP/ECRF/LIS crashes/restarts','TLS downgrades','IDS/WAF CVE hits'];
    else if(['phishing_workstation','ransomware_psap','misconfig_admin','supply_chain_component'].includes(id))
      sig=['Suspicious processes on PSAP hosts','EDR ransomware indicators','Privileged changes outside window','Unexpected vendor updates'];
    else sig=['Anomalous auth/config or request patterns','Error/latency/throughput anomalies'];
    lines.push(sig.map(s=>'- '+s).join('\\n'));
    lines.push('\\n## Triage\\n- Scope affected elements and paths\\n- Compare 24h vs 7d\\n- Validate certs/IDs/rates/schema');
    lines.push('\\n## Containment\\n- Block/rate-limit at BCF\\n- Quarantine & failover\\n- Disable creds; rotate keys');
    lines.push('\\n## Eradication\\n- Patch/reconfigure\\n- Rebuild if integrity uncertain\\n- Restore validated LVF/GIS');
    lines.push('\\n## Recovery\\n- Reintroduce traffic under monitoring\\n- Verify origination→BCF→ESRP→ECRF/LVF→PSAP\\n- Post-incident review');
    lines.push('\\n## Metrics/KPIs\\n- MTTD, MTTC, MTTR\\n- False positives\\n- % endpoints with mTLS/STIR-SHAKEN');
    return lines.join('\\n');
  }

  async function loadPlaybookMD(id){
    try{ const r=await fetch('playbooks/' + id + '.md', {cache:'no-store'}); if(r.ok) return await r.text(); }catch(e){}
    return null;
  }

  function createCell(tech){
    const c=document.createElement('div'); c.className='cell';
    c.innerHTML='<div class="title">'+esc(tech.name)+'</div><div class="meta">'+esc((tech.affected||[]).join(', '))+'</div>';
    return c;
  }

  function createColumn(tactic){
    const col=document.createElement('div'); col.className='column';
    const head=document.createElement('div'); head.className='col-head'; head.textContent=tactic.name; col.appendChild(head);
    const grid=document.createElement('div'); grid.className='cell-grid';
    (tactic.techniques||[]).forEach(tech=>{
      const c=createCell(tech);
      c.onclick=async ()=>{
        const title = tech.name + ' (' + tech.id + ')';
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-sub').textContent = 'Tactic: ' + tactic.name;

        const mitig = document.getElementById('mitigations'); mitig.innerHTML='';
        (tech.mitigations||tech.mitigation||[]).forEach(m=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=m; mitig.appendChild(s); });
        const aff = document.getElementById('affected'); aff.innerHTML='';
        (tech.affected||[]).forEach(a=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=a; aff.appendChild(s); });
        document.getElementById('evidence').textContent = tech.evidence || '(none)';

        let md = await loadPlaybookMD(tech.id);
        if(!md) md = buildPlaybookFromTech(tactic, tech);

        const html = renderMarkdown(md);
        const content = document.getElementById('modal-content');
        content.innerHTML = html; highlightCode();

        const rawHref = 'playbooks/' + tech.id + '.md';
        document.getElementById('btn-open-raw').href = rawHref;
        document.getElementById('btn-download').href = rawHref;
        document.getElementById('btn-download').setAttribute('download', tech.id + '.md');

        const bd=document.getElementById('backdrop'); bd.style.display='flex'; bd.setAttribute('aria-hidden','false');

        // PRINT — IMPORTANT: escape </script> so this inline script isn't terminated.
        document.getElementById('btn-print').onclick = ()=>{
          const safeHTML = html.replace(/<\/script>/gi, '<\\/script>');
          const doc = `
            <html><head>
              <meta charset="utf-8">
              <title>${title}</title>
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
              <style>
                body{{font-family:Inter,system-ui,Arial;padding:24px;background:#fff;color:#111}}
                h1,h2,h3{{margin:12px 0 6px}}
                pre{{border:1px solid #ddd;padding:12px;border-radius:8px;overflow:auto;background:#0a1f33;color:#e6eef8}}
                .meta{{margin:8px 0 16px;color:#444;font-size:12px}}
              </style>
            </head><body>
              <h1>${title}</h1>
              <div class="meta">Tactic: ${esc(tactic.name)}</div>
              ${safeHTML}
              <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>
              <script>try{hljs.highlightAll()}catch(e){}<\/script>
            </body></html>`;
          const w = window.open('', '_blank'); w.document.open(); w.document.write(doc); w.document.close(); setTimeout(()=>w.print(), 300);
        };
      };
      grid.appendChild(c);
    });
    col.appendChild(grid);
    return col;
  }

  async function load(){
    let mapping={tactics:[]};
    try{ const r=await fetch('mapping.json',{cache:'no-store'}); mapping=await r.json(); } catch(e){}
    const matrix=document.getElementById('matrix'); matrix.innerHTML='';
    (mapping.tactics||[]).forEach(t=>matrix.appendChild(createColumn(t)));
    const q=document.getElementById('q');
    q.oninput=()=>{
      const qv=q.value.trim().toLowerCase();
      const filtered=(mapping.tactics||[]).map(t=>{
        const techs=(t.techniques||[]).filter(tc=>tc.name.toLowerCase().includes(qv)||(tc.id||'').toLowerCase().includes(qv)||(tc.affected||[]).join(' ').toLowerCase().includes(qv));
        return { name:t.name, techniques:techs };
      }).filter(t=>t.techniques.length>0);
      matrix.innerHTML=''; filtered.forEach(t=>matrix.appendChild(createColumn(t)));
    };
  }
  document.getElementById('closeBtn').onclick=()=>{ const bd=document.getElementById('backdrop'); bd.style.display='none'; bd.setAttribute('aria-hidden','true'); };
  document.getElementById('backdrop').onclick=(e)=>{ if(e.target.id==='backdrop'){ const bd=document.getElementById('backdrop'); bd.style.display='none'; bd.setAttribute('aria-hidden','true'); }};
  load();
</script>
</body>
</html>
